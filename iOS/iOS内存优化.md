# iOS内存优化

如果系统运行内存不足，那么优先级不高或者使用内存较多的进程可能会被系统杀死。这种事情被称为`Jetsam Event`。在『设置->隐私->分析与改进->分析数据』中可以找到`JetsamEvent`报告，报告相关解释在[官方文档][https://developer.apple.com/documentation/xcode/identifying-high-memory-use-with-jetsam-event-reports]。作为客户端，我们能改进的地方是减少内存的使用，降低被系统杀死的风险。具体的方法有以下几点：

- 优化图片资源：
  1. 大内存图片并且不需要复用时，图片加载采取`contentsOfFile`，而不是`imageNamed`的方式，这样该图片不会被缓存而占用内存；
  2. 对大内存图片进行压缩
  3. 复用UI上的常用图片，如箭头、logo等，避免在asset里出现多次

- 丢弃未使用的视图对象：

​		在应用进入后台后，关掉如视频播放等占高内存操作，当app唤醒后，再次准备展示。

- 防止内存泄漏：

  项目中接入MLeaskFinder，开发过程中遇到内存泄漏提示，一定要解决掉，一个页面如果占用内存上百兆，并且发生内存泄漏，那么几次开关，内存可能就会上1G，这是很可怕的。

- 单例中的引用：

  单例因为其机制，会长期保存在内存中，因此单例中对引用的管理很重要，如果有大内存的引用，记得适时清除

- 适当的缓存策略：

  项目中有出现页面包含大量的车辆品牌列表，全部是从网络加载获取，因为图片加载框架的默认加载策略是内存、硬盘都会存储，因此快速滑动列表时，会导致内存的暴涨。此时，可以更换到存储策略。并且通过框架为图片列表指定特别的内存块，在离开列表页面时，立即清理掉相应的内存

- 数据库使用：

  Core Data将更改存储在内存中，直到它们的关联被保存，此时它将更改写入父级或持久存储。在更改进入持久存储之前，它们一直驻留在内存中，这样Core Data相关的内存会越来越大。相反，如果保存得越频繁，IO操作就会越多，这也会影响性能。因此应该在保存次数上找到相对平衡。其它数据库（sqlite,realm）的操作也是如此。

- 收到内存警告：

  1.在应用程序收到`applicationDidReceiveMemoryWarning(_:)`和控制器收到`didReceiveMemoryWarning`,可以对内存进行管理释放，占用内存较高的页面，尤其需要注意处理，例如视频播放、地图等。并且如果一次性分配大量内存，也可能会收到警告，此时可以修改分配方式，缓慢分配内存。

- Xcode：

  在日常使用Xcode开发时，应该时常对内存的使用量进行关注，对内存暴涨、或始终不释放的情况加以解决。

